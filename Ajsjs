local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local WS = game:GetService("Workspace")
local LP = Players.LocalPlayer
local Mouse = LP:GetMouse()
local Camera = WS.CurrentCamera
local UIS = game:GetService("UserInputService")

local Target = nil
local CamlockEnabled = false
local ESPEnabled = false
local AutoAir = false

local Prediction = {X = 1.8, Y = 1.2}
local FOVRadius = 150

local ScreenGui = Instance.new("ScreenGui", LP:WaitForChild("PlayerGui"))
ScreenGui.ResetOnSpawn = false

-- Wally UI Load
local Library = loadstring(game:HttpGet("https://pastebin.com/raw/RSxYjAzcpLLruCcQOXxgDpeacmNxWVSA"))()
local Window = Library:CreateWindow("Dead Rails")

local Combat = Window:CreateFolder("Combat")
Combat:Toggle("Kill Aura", function(val)
    getgenv().KillAura = val
end)

Combat:Toggle("Camlock", function(val)
    CamlockEnabled = val
end)

Combat:Slider("Prediction X", {
    min = 0,
    max = 3,
    precise = true,
}, function(val)
    Prediction.X = val
end)

Combat:Slider("Prediction Y", {
    min = 0,
    max = 3,
    precise = true,
}, function(val)
    Prediction.Y = val
end)

local Misc = Window:CreateFolder("Misc")
Misc:Toggle("Bring Items", function(val)
    getgenv().BringItems = val
end)

Misc:Toggle("Auto Bonds", function(val)
    getgenv().AutoBonds = val
end)

Misc:Toggle("Air Weld", function(val)
    AutoAir = val
end)

-- External Mobile Buttons
function CreateButton(name, pos, callback)
    local btn = Instance.new("TextButton", ScreenGui)
    btn.Size = UDim2.new(0, 100, 0, 40)
    btn.Position = pos
    btn.Text = name
    btn.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.MouseButton1Click:Connect(callback)
    return btn
end

CreateButton("ESP", UDim2.new(0, 20, 0, 120), function()
    ESPEnabled = not ESPEnabled
end)

CreateButton("Camlock", UDim2.new(0, 20, 0, 170), function()
    CamlockEnabled = not CamlockEnabled
end)

CreateButton("Auto Air", UDim2.new(0, 20, 0, 220), function()
    AutoAir = not AutoAir
end)

-- Air Weld Function
spawn(function()
    while task.wait(1) do
        if AutoAir and LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
            local HRP = LP.Character.HumanoidRootPart
            for _,w in pairs(HRP:GetChildren()) do
                if w:IsA("Weld") then w:Destroy() end
            end
            local bv = Instance.new("BodyVelocity", HRP)
            bv.Velocity = Vector3.zero
            bv.MaxForce = Vector3.new(1/0, 1/0, 1/0)
            task.wait(0.1)
            bv:Destroy()
        end
    end
end)

-- Kill Aura
spawn(function()
    while task.wait() do
        if getgenv().KillAura then
            for _,plr in pairs(Players:GetPlayers()) do
                if plr ~= LP and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                    RS.Events.Damage:FireServer(plr.Character.HumanoidRootPart, 99999)
                end
            end
        end
    end
end)

-- Bring Items
spawn(function()
    while task.wait(2) do
        if getgenv().BringItems and LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
            for _,tool in pairs(WS:GetDescendants()) do
                if tool:IsA("Tool") and tool:FindFirstChild("Handle") then
                    tool.Handle.CFrame = LP.Character.HumanoidRootPart.CFrame
                end
            end
        end
    end
end)

-- Auto Bonds
spawn(function()
    while task.wait(2) do
        if getgenv().AutoBonds and LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
            for _,bond in pairs(WS:GetDescendants()) do
                if bond:IsA("Model") and bond.Name == "Bond" and bond:FindFirstChild("Main") then
                    bond.Main.CFrame = LP.Character.HumanoidRootPart.CFrame
                end
            end
        end
    end
end)

-- Camlock Logic
function GetClosest()
    local closest, dist = nil, FOVRadius
    for _,plr in pairs(Players:GetPlayers()) do
        if plr ~= LP and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local pos, onScreen = Camera:WorldToViewportPoint(plr.Character.HumanoidRootPart.Position)
            if onScreen then
                local mag = (Vector2.new(pos.X, pos.Y) - Vector2.new(Mouse.X, Mouse.Y)).Magnitude
                if mag < dist then
                    closest = plr
                    dist = mag
                end
            end
        end
    end
    return closest
end

-- Camlock Movement
game:GetService("RunService").RenderStepped:Connect(function()
    if CamlockEnabled and LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
        if not Target or not Target.Character or not Target.Character:FindFirstChild("HumanoidRootPart") then
            Target = GetClosest()
            if Target then
                game.StarterGui:SetCore("SendNotification", {
                    Title = "Target Locked",
                    Text = Target.Name,
                    Duration = 1
                })
            end
        end
        if Target and Target.Character and Target.Character:FindFirstChild("HumanoidRootPart") then
            local pred = Target.Character.HumanoidRootPart.Velocity * Vector3.new(Prediction.X, Prediction.Y, Prediction.X)
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, Target.Character.HumanoidRootPart.Position + pred)
        end
    else
        Target = nil
    end
end)
